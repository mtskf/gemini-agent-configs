# Agent Rules

## ⛔ CRITICAL: BEFORE USING `write_to_file` / `replace_file_content`

You MUST run this check before calling any tool that modifies files:

```bash
git branch --show-current
```

- **If output is `main`** → **STOP IMMEDIATELY**. Do NOT execute the file modification.
- **Action**: Run the `/start_task` workflow to create a feature branch first.

> **This check is NON-NEGOTIABLE. No exceptions.**
> Modifications on `main` are strictly forbidden.

---

## ⛔ CRITICAL: IMPLEMENTATION POLICY
**Strictly forbidden to implement features without explicit user request.**

1. **Explicit Consent Required**: You must NOT implement features, add libraries, or perform major refactoring that has not been explicitly requested by the user.
2. **Propose First**: If you believe an unrequested feature would be beneficial (e.g., to fix a bug or improve UX), you must **propose it first** and wait for the user's explicit confirmation before writing any code.
3. **Stick to the Scope**: Focus strictly on solving the stated problem. Avoid "nice-to-have" additions unless authorized.

---

## Git Workflow (CRITICAL)

| Action | Rule |
|--------|------|
| Direct push to `main` | ❌ FORBIDDEN |
| Work on `main` branch | ❌ FORBIDDEN |
| Create feature branch | ✅ Use `/start_task` |
| Before push to existing branch | ✅ Run `gh pr view` to check status |
| Auto-Merge PR | ❌ FORBIDDEN (Require explicit user approval) |
| Commit format | ✅ Conventional Commits (`feat:`, `fix:`, `docs:`) |
| Release | ✅ MUST use `/release` workflow (packages go to `release/`) |

---

## Information Priority

1. **Artifacts** (`task.md`, `implementation_plan.md`): Source of truth during task execution
2. **Codebase**: Actual code
3. **Docs**: `dev-docs/` documentation

## Task Management

- Sync `task_boundary` with top-level items in `task.md`
- Create `implementation_plan.md` in PLANNING mode, get user approval before EXECUTION
- **Session Reset**: If context becomes too long or confused, propose saving progress to `task.md` and starting a new chat

## Self-Correction

- On error: Analyze → Fix → Retry (don't immediately ask user for help)

---

## Communication

- **Language**: Conversation/Artifacts in Japanese, Code/Commits/Docs in English
- **Style**: Result-focused, no filler phrases
- **Uncertainty**: Use `notify_user` instead of guessing

## Engineering

- **Quality**: Run build after changes, run `lint_and_test` workflow to verify
- **Testing**: Add tests for new features
- **Test Integrity**: Fix env issues in tests/config, NEVER in source.
- **Docs**: Update README/dev-docs with code changes
- **Assets**: Store images generated by Nano Banana (or any tool) in `temp/ images/` (create if missing)
- **Structure**: Ensure `dev-docs/{ARCHITECTURE,CHANGELOG,DECISIONS,LESSONS,TECH_STACK,SPEC}.md` exist; create if missing

## Workflows

| Workflow | Purpose |
|----------|---------|
| `/start_task` | Create branch, load context |
| `/finalize_task` | Create PR, cleanup |
| `/sync_main` | Sync with remote main |
| `/lint_and_test` | Run lint & test |
| `/release` | Version bump & release |
